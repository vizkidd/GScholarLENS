function uniq(e){return Array.from(new Set(e))}const replaceSpecialChars=e=>{let t={à:"a",á:"a",â:"a",ã:"a",ä:"a",å:"a",æ:"ae",ā:"a",ç:"c",ć:"c",ĉ:"c",č:"c",ç:"c",è:"e",é:"e",ê:"e",ë:"e",ē:"e",ė:"e",ę:"e",ì:"i",í:"i",î:"i",ï:"i",ī:"i",į:"i",ı:"i",ñ:"n",ń:"n",ň:"n",ò:"o",ó:"o",ô:"o",õ:"o",ö:"o",ø:"o",ō:"o",ó:"o",œ:"oe",ù:"u",ú:"u",û:"u",ü:"u",ū:"u",ý:"y",ÿ:"y",ž:"z",ź:"z",ż:"z",À:"A",Á:"A",Â:"A",Ã:"A",Ä:"A",Å:"A",Æ:"AE",Ā:"A",Ç:"C",Ć:"C",Ĉ:"C",Č:"C",È:"E",É:"E",Ê:"E",Ë:"E",Ē:"E",Ė:"E",Ę:"E",Ì:"I",Í:"I",Î:"I",Ï:"I",Ī:"I",Į:"I",İ:"I",Ñ:"N",Ń:"N",Ň:"N",Ò:"O",Ó:"O",Ô:"O",Õ:"O",Ö:"O",Ø:"O",Ō:"O",Œ:"OE",Ù:"U",Ú:"U",Û:"U",Ü:"U",Ū:"U",Ý:"Y",Ÿ:"Y",Ž:"Z",Ź:"Z",Ż:"Z",œ:"oe",ř:"r",š:"s",ţ:"t",ū:"u",ý:"y"};return e.split("").map(e=>t[e]||e).join("").replace(/[\u2010-\u2015\u2212\uFE58\u2043]/g,"-")},normalizeString=e=>e.normalize("NFD").replace(/[\u0300-\u036f]/g,""),cleanStringSpaces=e=>e.replace(/\s+/g," ").trim(),cleanAndNormalize=e=>replaceSpecialChars(e).normalize("NFC").replace(/\s+/g," ").trim().toLowerCase(),areEqual=(e,t)=>0===cleanAndNormalize(e).localeCompare(cleanAndNormalize(t),void 0,{sensitivity:"base"});function adjustIndexForSymbols(e,t){let o=t;for(;o>0&&(e[o].includes("^")||e[o].includes("*"));)o--;return o}function processAuthorPositions(e,t,o,r,s,a,i,c){let n=adjustIndexForSymbols(o,s),u="NA";return e.has(i)||e.set(i,new Map),e.get(i).has("author_pos_contrib")||(e.get(i).set("author_pos_contrib",new Map),e.get(i).get("author_pos_contrib").set("first_author",0),e.get(i).get("author_pos_contrib").set("second_author",0),e.get(i).get("author_pos_contrib").set("co_author",0),e.get(i).get("author_pos_contrib").set("corresponding_author",0)),e.get(i).has("author_pos_cite_contrib")||(e.get(i).set("author_pos_cite_contrib",new Map),e.get(i).get("author_pos_cite_contrib").set("first_author",0),e.get(i).get("author_pos_cite_contrib").set("second_author",0),e.get(i).get("author_pos_cite_contrib").set("co_author",0),e.get(i).get("author_pos_cite_contrib").set("corresponding_author",0)),e.get(i).has("author_pos_cite_map")||(e.get(i).set("author_pos_cite_map",new Map),e.get(i).get("author_pos_cite_map").set("first_author",[]),e.get(i).get("author_pos_cite_map").set("second_author",[]),e.get(i).get("author_pos_cite_map").set("co_author",[]),e.get(i).get("author_pos_cite_map").set("corresponding_author",[])),e.get(i).has("author_pos_cite_qscore")||(e.get(i).set("author_pos_cite_qscore",new Map),e.get(i).get("author_pos_cite_qscore").set("first_author",new Map),e.get(i).get("author_pos_cite_qscore").set("second_author",new Map),e.get(i).get("author_pos_cite_qscore").set("co_author",new Map),e.get(i).get("author_pos_cite_qscore").set("corresponding_author",new Map),e.get(i).get("author_pos_cite_qscore").get("first_author").set("Q1",0),e.get(i).get("author_pos_cite_qscore").get("first_author").set("Q2",0),e.get(i).get("author_pos_cite_qscore").get("first_author").set("Q3",0),e.get(i).get("author_pos_cite_qscore").get("first_author").set("Q4",0),e.get(i).get("author_pos_cite_qscore").get("first_author").set("NA",0),e.get(i).get("author_pos_cite_qscore").get("second_author").set("Q1",0),e.get(i).get("author_pos_cite_qscore").get("second_author").set("Q2",0),e.get(i).get("author_pos_cite_qscore").get("second_author").set("Q3",0),e.get(i).get("author_pos_cite_qscore").get("second_author").set("Q4",0),e.get(i).get("author_pos_cite_qscore").get("second_author").set("NA",0),e.get(i).get("author_pos_cite_qscore").get("co_author").set("Q1",0),e.get(i).get("author_pos_cite_qscore").get("co_author").set("Q2",0),e.get(i).get("author_pos_cite_qscore").get("co_author").set("Q3",0),e.get(i).get("author_pos_cite_qscore").get("co_author").set("Q4",0),e.get(i).get("author_pos_cite_qscore").get("co_author").set("NA",0),e.get(i).get("author_pos_cite_qscore").get("corresponding_author").set("Q1",0),e.get(i).get("author_pos_cite_qscore").get("corresponding_author").set("Q2",0),e.get(i).get("author_pos_cite_qscore").get("corresponding_author").set("Q3",0),e.get(i).get("author_pos_cite_qscore").get("corresponding_author").set("Q4",0),e.get(i).get("author_pos_cite_qscore").get("corresponding_author").set("NA",0)),t.includes("*")||n+1===o.length?(u="corresponding_author",e.get(i).get("author_pos_contrib").set("corresponding_author",e.get(i).get("author_pos_contrib").get("corresponding_author")+1),e.get(i).get("author_pos_cite_contrib").set("corresponding_author",e.get(i).get("author_pos_cite_contrib").get("corresponding_author")+r),e.get(i).get("author_pos_cite_map").get("corresponding_author").push(r)):0===n?(u="first_author",e.get(i).get("author_pos_contrib").set("first_author",e.get(i).get("author_pos_contrib").get("first_author")+1),e.get(i).get("author_pos_cite_contrib").set("first_author",e.get(i).get("author_pos_cite_contrib").get("first_author")+r),e.get(i).get("author_pos_cite_map").get("first_author").push(r)):1===n?(u="second_author",e.get(i).get("author_pos_contrib").set("second_author",e.get(i).get("author_pos_contrib").get("second_author")+1),e.get(i).get("author_pos_cite_contrib").set("second_author",e.get(i).get("author_pos_cite_contrib").get("second_author")+r),e.get(i).get("author_pos_cite_map").get("second_author").push(r)):n>1&&n+1<o.length?(u="co_author",e.get(i).get("author_pos_contrib").set("co_author",e.get(i).get("author_pos_contrib").get("co_author")+1),e.get(i).get("author_pos_cite_contrib").set("co_author",e.get(i).get("author_pos_cite_contrib").get("co_author")+r),e.get(i).get("author_pos_cite_map").get("co_author").push(r)):(console.log("IDX:",c.index,"Adj idx:",adj_idx,"Author:",t,"Position:",u,"Citations:",r,"QScore:",a),console.warn(c.index,c.author_pos)),e.get(i).get("author_pos_cite_qscore").get(u).set(a,e.get(i).get("author_pos_cite_qscore").get(u).get(a)+r),u}function sendZeroCopyArr(e){let t=new TextEncoder,o=JSON.stringify(e),r=t.encode(o);self.postMessage(r.buffer,[r.buffer])}self.onmessage=async({data:e})=>{let{task:t,batch:o,authorRegexes:r,authorRegexesEx:s,nameComboList:a,otherNamesList:i,authorNameShort:c,authorName:n,authorNameLong:u}=e,g=[],h=!1,p=new Map,l=new TextEncoder;function d(e){let t=replaceSpecialChars(normalizeString(e)).toLowerCase(),o=[];return r.forEach(e=>{o.push(e.test(t))}),o.push(t.includes(c.toLowerCase())),o.push(areEqual(e,n)),o.push(i.includes(normalizeString(e.trim()))),o.push(a.includes(e.trim())),o.some(e=>!0===e)}try{for(let f of o){h=!1;let m=f.index,$=f.authors,b=f.citations,q="NA",w=$.split(",").map(e=>e.trim());if(f.total_authors=w.length,"initialScrape"===t){let A=!1,C=w.filter(d);if((uniq(C).length>1||0===C.length)&&$.includes("...")){f.considered=!1,h=!1,f.extended_scrape=!0;let S={type:"working",task:"initialScrape",authorFound:h,extended_scrape:A,publication:f};sendZeroCopyArr(S);continue}w.forEach(async(e,t)=>{if(h)return;if(e.includes("...")&&!h){f.extended_scrape=!0,f.considered=!1;return}let o=replaceSpecialChars(normalizeString(e)).toLowerCase();if(o.includes(c.toLowerCase())||o.includes(u.toLowerCase())||areEqual(e,n)||i.includes(normalizeString(e.trim()))){let s=[];if(r.forEach(e=>{s.push(e.test(o))}),s.push(i.includes(normalizeString(e.trim()))),s.some(e=>!0===e)){let a=e.replace(/[\*\^']|_/g,"").replace(/\s+/g," ").trim();g.push(a),q=processAuthorPositions(p,e,w,b,t,f.journalRanking,f.year,m,f),h=!0}}}),h?(f.author_pos=q,f.considered=!0):(f.extended_scrape=!0,f.considered=!1);let y={type:"working",task:"initialScrape",authorFound:h,extended_scrape:A,publication:f};sendZeroCopyArr(y)}else if("extendedScrape"===t){function _(e){let t=replaceSpecialChars(normalizeString(e)).toLowerCase(),o=[];return s.forEach(e=>{o.push(e.test(t))}),o.push(areEqual(e,n)),o.push(i.includes(normalizeString(e.trim()))),o.push(a.includes(e.trim())),o.some(e=>!0===e)}let E=!0,z=$.split(",").map(e=>e.trim()),Q=z.filter(_);0===Q.length&&(Q=z.filter(d),E=!1);let x=E?s:r;0===Q.length||"Authors not found"===f.authors?(h=!1,f.considered=!1):(z.forEach(async(e,t)=>{if(h)return;let o=replaceSpecialChars(normalizeString(e)).toLowerCase();if(o.includes(c.toLowerCase())||o.includes(u.toLowerCase())||areEqual(e,n)||i.includes(normalizeString(e.trim()))){let r=[];if(x.forEach(e=>{r.push(e.test(o))}),r.push(i.includes(normalizeString(e.trim()))),r.some(e=>!0===e)){h=!0;let s=e.replace(/[^\w\s\']|_/g,"").replace(/\s+/g," ").trim();g.push(s),q=processAuthorPositions(p,e,z,b,t,f.journalRanking,f.year,m,f),f.considered=!0}}}),h&&(f.author_pos=q));let N={type:"working",task:"extendedScrape",authorFound:h,extended_check:E,publication:f};sendZeroCopyArr(N)}}function k(e){return e instanceof Map?Array.from(e.entries()).map(([e,t])=>[e,k(t)]):Array.isArray(e)?e.slice():e}let I={type:"done",task:t,authorNamesConsidered:g,yearwiseData:Array.from(p.entries()).map(([e,t])=>[e,k(t)])};sendZeroCopyArr(I)}catch(L){let F={type:"error",task:t,error:L.message},O=JSON.stringify(F),Z=l.encode(O);self.postMessage(Z.buffer,[Z.buffer])}};