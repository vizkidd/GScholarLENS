function uniq(t){return Array.from(new Set(t))}const replaceSpecialChars=t=>{let e={à:"a",á:"a",â:"a",ã:"a",ä:"a",å:"a",æ:"ae",ā:"a",ç:"c",ć:"c",ĉ:"c",č:"c",ç:"c",è:"e",é:"e",ê:"e",ë:"e",ē:"e",ė:"e",ę:"e",ì:"i",í:"i",î:"i",ï:"i",ī:"i",į:"i",ı:"i",ñ:"n",ń:"n",ň:"n",ò:"o",ó:"o",ô:"o",õ:"o",ö:"o",ø:"o",ō:"o",ó:"o",œ:"oe",ù:"u",ú:"u",û:"u",ü:"u",ū:"u",ý:"y",ÿ:"y",ž:"z",ź:"z",ż:"z",À:"A",Á:"A",Â:"A",Ã:"A",Ä:"A",Å:"A",Æ:"AE",Ā:"A",Ç:"C",Ć:"C",Ĉ:"C",Č:"C",È:"E",É:"E",Ê:"E",Ë:"E",Ē:"E",Ė:"E",Ę:"E",Ì:"I",Í:"I",Î:"I",Ï:"I",Ī:"I",Į:"I",İ:"I",Ñ:"N",Ń:"N",Ň:"N",Ò:"O",Ó:"O",Ô:"O",Õ:"O",Ö:"O",Ø:"O",Ō:"O",Œ:"OE",Ù:"U",Ú:"U",Û:"U",Ü:"U",Ū:"U",Ý:"Y",Ÿ:"Y",Ž:"Z",Ź:"Z",Ż:"Z",œ:"oe",ř:"r",š:"s",ţ:"t",ū:"u",ý:"y"};return t.split("").map(t=>e[t]||t).join("").replace(/[\u2010-\u2015\u2212\uFE58\u2043]/g,"-")},normalizeString=t=>t.normalize("NFD").replace(/[\u0300-\u036f]/g,""),cleanStringSpaces=t=>t.replace(/\s+/g," ").trim(),cleanAndNormalize=t=>replaceSpecialChars(t).normalize("NFC").replace(/\s+/g," ").trim().toLowerCase(),areEqual=(t,e)=>0===cleanAndNormalize(t).localeCompare(cleanAndNormalize(e),void 0,{sensitivity:"base"});function adjustIndexForSymbols(t,e){let o=e;for(;o>0&&(t[o].includes("^")||t[o].includes("*"));)o--;return o}function processAuthorPositions(t,e,o,r,s,a,i,c){let n=adjustIndexForSymbols(o,s),u="NA";return t.has(i)||t.set(i,new Map),t.get(i).has("author_pos_contrib")||(t.get(i).set("author_pos_contrib",new Map),t.get(i).get("author_pos_contrib").set("first_author",0),t.get(i).get("author_pos_contrib").set("second_author",0),t.get(i).get("author_pos_contrib").set("co_author",0),t.get(i).get("author_pos_contrib").set("corresponding_author",0)),t.get(i).has("author_pos_cite_contrib")||(t.get(i).set("author_pos_cite_contrib",new Map),t.get(i).get("author_pos_cite_contrib").set("first_author",0),t.get(i).get("author_pos_cite_contrib").set("second_author",0),t.get(i).get("author_pos_cite_contrib").set("co_author",0),t.get(i).get("author_pos_cite_contrib").set("corresponding_author",0)),t.get(i).has("author_pos_cite_map")||(t.get(i).set("author_pos_cite_map",new Map),t.get(i).get("author_pos_cite_map").set("first_author",[]),t.get(i).get("author_pos_cite_map").set("second_author",[]),t.get(i).get("author_pos_cite_map").set("co_author",[]),t.get(i).get("author_pos_cite_map").set("corresponding_author",[])),t.get(i).has("author_pos_cite_qscore")||(t.get(i).set("author_pos_cite_qscore",new Map),t.get(i).get("author_pos_cite_qscore").set("first_author",new Map),t.get(i).get("author_pos_cite_qscore").set("second_author",new Map),t.get(i).get("author_pos_cite_qscore").set("co_author",new Map),t.get(i).get("author_pos_cite_qscore").set("corresponding_author",new Map),t.get(i).get("author_pos_cite_qscore").get("first_author").set("Q1",0),t.get(i).get("author_pos_cite_qscore").get("first_author").set("Q2",0),t.get(i).get("author_pos_cite_qscore").get("first_author").set("Q3",0),t.get(i).get("author_pos_cite_qscore").get("first_author").set("Q4",0),t.get(i).get("author_pos_cite_qscore").get("first_author").set("NA",0),t.get(i).get("author_pos_cite_qscore").get("second_author").set("Q1",0),t.get(i).get("author_pos_cite_qscore").get("second_author").set("Q2",0),t.get(i).get("author_pos_cite_qscore").get("second_author").set("Q3",0),t.get(i).get("author_pos_cite_qscore").get("second_author").set("Q4",0),t.get(i).get("author_pos_cite_qscore").get("second_author").set("NA",0),t.get(i).get("author_pos_cite_qscore").get("co_author").set("Q1",0),t.get(i).get("author_pos_cite_qscore").get("co_author").set("Q2",0),t.get(i).get("author_pos_cite_qscore").get("co_author").set("Q3",0),t.get(i).get("author_pos_cite_qscore").get("co_author").set("Q4",0),t.get(i).get("author_pos_cite_qscore").get("co_author").set("NA",0),t.get(i).get("author_pos_cite_qscore").get("corresponding_author").set("Q1",0),t.get(i).get("author_pos_cite_qscore").get("corresponding_author").set("Q2",0),t.get(i).get("author_pos_cite_qscore").get("corresponding_author").set("Q3",0),t.get(i).get("author_pos_cite_qscore").get("corresponding_author").set("Q4",0),t.get(i).get("author_pos_cite_qscore").get("corresponding_author").set("NA",0)),e.includes("*")||n+1===o.length?(u="corresponding_author",t.get(i).get("author_pos_contrib").set("corresponding_author",t.get(i).get("author_pos_contrib").get("corresponding_author")+1),t.get(i).get("author_pos_cite_contrib").set("corresponding_author",t.get(i).get("author_pos_cite_contrib").get("corresponding_author")+r),t.get(i).get("author_pos_cite_map").get("corresponding_author").push(r)):0===n?(u="first_author",t.get(i).get("author_pos_contrib").set("first_author",t.get(i).get("author_pos_contrib").get("first_author")+1),t.get(i).get("author_pos_cite_contrib").set("first_author",t.get(i).get("author_pos_cite_contrib").get("first_author")+r),t.get(i).get("author_pos_cite_map").get("first_author").push(r)):1===n?(u="second_author",t.get(i).get("author_pos_contrib").set("second_author",t.get(i).get("author_pos_contrib").get("second_author")+1),t.get(i).get("author_pos_cite_contrib").set("second_author",t.get(i).get("author_pos_cite_contrib").get("second_author")+r),t.get(i).get("author_pos_cite_map").get("second_author").push(r)):n>1&&n+1<o.length?(u="co_author",t.get(i).get("author_pos_contrib").set("co_author",t.get(i).get("author_pos_contrib").get("co_author")+1),t.get(i).get("author_pos_cite_contrib").set("co_author",t.get(i).get("author_pos_cite_contrib").get("co_author")+r),t.get(i).get("author_pos_cite_map").get("co_author").push(r)):(console.log("IDX:",c.index,"Adj idx:",adj_idx,"Author:",e,"Position:",u,"Citations:",r,"QScore:",a),console.warn(c.index,c.author_pos)),t.get(i).get("author_pos_cite_qscore").get(u).set(a,t.get(i).get("author_pos_cite_qscore").get(u).get(a)+r),u}function sendZeroCopyArr(t){let e=new TextEncoder,o=JSON.stringify(t),r=e.encode(o);self.postMessage(r.buffer,[r.buffer])}self.onmessage=async({data:t})=>{let{task:e,batch:o,authorRegexes:r,authorRegexesEx:s,nameComboList:a,otherNamesList:i,authorNameShort:c,authorName:n,authorNameLong:u}=t,g=[],h=!1,p=new Map,l=new TextEncoder;function d(t){let e=replaceSpecialChars(normalizeString(t)).toLowerCase(),o=[];return r.forEach(t=>{o.push(t.test(e))}),o.push(e.includes(c.toLowerCase())),o.push(areEqual(t,n)),o.push(i.includes(normalizeString(t.trim()))),o.push(a.includes(t.trim())),o.some(t=>!0===t)}try{for(let f of o){h=!1;let m=f.index,$=f.authors,b=f.citations,q="NA",w=$.split(",").map(t=>t.trim());if(f.total_authors=w.length,"initialScrape"===e){let A=!1,C=w.filter(d);if((uniq(C).length>1||0===C.length)&&$.includes("...")){f.authors="Pending",f.considered=!1,h=!1,A=!0;let S={type:"working",task:"initialScrape",authorFound:h,extended_scrape:A,publication:f};sendZeroCopyArr(S);continue}w.forEach(async(t,e)=>{if(h)return;if(t.includes("...")&&!h){f.authors="Pending",A=!0,f.considered=!1;return}let o=replaceSpecialChars(normalizeString(t)).toLowerCase();if(o.includes(c.toLowerCase())||o.includes(u.toLowerCase())||areEqual(t,n)||i.includes(normalizeString(t.trim()))){let s=[];if(r.forEach(t=>{s.push(t.test(o))}),s.push(i.includes(normalizeString(t.trim()))),s.some(t=>!0===t)){let a=t.replace(/[\*\^']|_/g,"").replace(/\s+/g," ").trim();g.push(a),q=processAuthorPositions(p,t,w,b,e,f.journalRanking,f.year,m,f),h=!0}}}),h?(f.author_pos=q,f.considered=!0):(f.authors="Pending",A=!0,f.considered=!1);let y={type:"working",task:"initialScrape",authorFound:h,extended_scrape:A,publication:f};sendZeroCopyArr(y)}else if("extendedScrape"===e){function _(t){let e=replaceSpecialChars(normalizeString(t)).toLowerCase(),o=[];return s.forEach(t=>{o.push(t.test(e))}),o.push(areEqual(t,n)),o.push(i.includes(normalizeString(t.trim()))),o.push(a.includes(t.trim())),o.some(t=>!0===t)}let E=!0,z=$.split(",").map(t=>t.trim()),Q=z.filter(_);0===Q.length&&(Q=z.filter(d),E=!1);let N=E?s:r;0===Q.length||"Authors not found"===f.authors?(h=!1,f.considered=!1):(z.forEach(async(t,e)=>{if(h)return;let o=replaceSpecialChars(normalizeString(t)).toLowerCase();if(o.includes(c.toLowerCase())||o.includes(u.toLowerCase())||areEqual(t,n)||i.includes(normalizeString(t.trim()))){let r=[];if(N.forEach(t=>{r.push(t.test(o))}),r.push(i.includes(normalizeString(t.trim()))),r.some(t=>!0===t)){h=!0;let s=t.replace(/[^\w\s\']|_/g,"").replace(/\s+/g," ").trim();g.push(s),q=processAuthorPositions(p,t,z,b,e,f.journalRanking,f.year,m,f),f.considered=!0}}}),h&&(f.author_pos=q));let x={type:"working",task:"extendedScrape",authorFound:h,extended_check:E,publication:f};sendZeroCopyArr(x)}}function k(t){return t instanceof Map?Array.from(t.entries()).map(([t,e])=>[t,k(e)]):Array.isArray(t)?t.slice():t}let I={type:"done",task:e,authorNamesConsidered:g,yearwiseData:Array.from(p.entries()).map(([t,e])=>[t,k(e)])};sendZeroCopyArr(I)}catch(L){let F={type:"error",task:e,error:L.message},O=JSON.stringify(F),Z=l.encode(O);self.postMessage(Z.buffer,[Z.buffer])}};