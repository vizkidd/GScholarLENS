// permissions.js

(async () => {
  const permListEl = document.getElementById('perm-list');
  const btn = document.getElementById('request-btn');
// console.log('permissions.js loaded');
  // 1) Get all declared optional permissions from the manifest
  const manifest = chrome.runtime.getManifest();
    const permissions = !chrome.permissions ? !browser.permissions ? null : browser.permissions : chrome.permissions;//manifest.optional_permissions || {};
  // console.log('permissions', await permissions.getAll());
    // console.log('manifest', manifest); 
  const origins = manifest.host_permissions || [];
  const perms   = manifest.optional_permissions || [];
    // if (origins.length === 0) { 
        
    //     origins.push("*://gitlab.com/crossref/retraction-watch-data/*");
    //     origins.push("*://scholar.google.com/*");
    //     origins.push("*://scholar.google.at/*");
    //     origins.push("*://scholar.google.be/*");
    //     origins.push("*://scholar.google.bg/*");
    //     origins.push("*://scholar.google.ca/*");
    //     origins.push("*://scholar.google.cat/*");
    //     origins.push("*://scholar.google.ch/*");
    //     origins.push("*://scholar.google.cl/*");
    //     origins.push("*://scholar.google.co.cr/*");
    //     origins.push("*://scholar.google.co.hu/*");
    //     origins.push("*://scholar.google.co.id/*");
    //     origins.push("*://scholar.google.co.il/*");
    //     origins.push("*://scholar.google.co.in/*");
    //     origins.push("*://scholar.google.co.jp/*");
    //     origins.push("*://scholar.google.co.kr/*");
    //     origins.push("*://scholar.google.co.nz/*");
    //     origins.push("*://scholar.google.co.th/*");
    //     origins.push("*://scholar.google.co.uk/*");
    //     origins.push("*://scholar.google.co.ve/*");
    //     origins.push("*://scholar.google.co.za/*");
    //     origins.push("*://scholar.google.com/*");
    //     origins.push("*://scholar.google.com.ar/*");
    //     origins.push("*://scholar.google.com.au/*");
    //     origins.push("*://scholar.google.com.bo/*");
    //     origins.push("*://scholar.google.com.br/*");
    //     origins.push("*://scholar.google.com.co/*");
    //     origins.push("*://scholar.google.com.cu/*");
    //     origins.push("*://scholar.google.com.do/*");
    //     origins.push("*://scholar.google.com.ec/*");
    //     origins.push("*://scholar.google.com.eg/*");
    //     origins.push("*://scholar.google.com.gr/*");
    //     origins.push("*://scholar.google.com.gt/*");
    //     origins.push("*://scholar.google.com.hk/*");
    //     origins.push("*://scholar.google.com.ly/*");
    //     origins.push("*://scholar.google.com.mx/*");
    //     origins.push("*://scholar.google.com.my/*");
    //     origins.push("*://scholar.google.com.ni/*");
    //     origins.push("*://scholar.google.com.pa/*");
    //     origins.push("*://scholar.google.com.pe/*");
    //     origins.push("*://scholar.google.com.ph/*");
    //     origins.push("*://scholar.google.com.pk/*");
    //     origins.push("*://scholar.google.com.pl/*");
    //     origins.push("*://scholar.google.com.pr/*");
    //     origins.push("*://scholar.google.com.py/*");
    //     origins.push("*://scholar.google.com.ru/*");
    //     origins.push("*://scholar.google.com.sg/*");
    //     origins.push("*://scholar.google.com.sv/*");
    //     origins.push("*://scholar.google.com.tr/*");
    //     origins.push("*://scholar.google.com.tw/*");
    //     origins.push("*://scholar.google.com.ua/*");
    //     origins.push("*://scholar.google.com.uy/*");
    //     origins.push("*://scholar.google.com.vn/*");
    //     origins.push("*://scholar.google.cz/*");
    //     origins.push("*://scholar.google.de/*");
    //     origins.push("*://scholar.google.dk/*");
    //     origins.push("*://scholar.google.es/*");
    //     origins.push("*://scholar.google.fi/*");
    //     origins.push("*://scholar.google.fr/*");
    //     origins.push("*://scholar.google.gr/*");
    //     origins.push("*://scholar.google.hk/*");
    //     origins.push("*://scholar.google.hn/*");
    //     origins.push("*://scholar.google.hr/*");
    //     origins.push("*://scholar.google.hu/*");
    //     origins.push("*://scholar.google.is/*");
    //     origins.push("*://scholar.google.it/*");
    //     origins.push("*://scholar.google.li/*");
    //     origins.push("*://scholar.google.lt/*");
    //     origins.push("*://scholar.google.lu/*");
    //     origins.push("*://scholar.google.lv/*");
    //     origins.push("*://scholar.google.nl/*");
    //     origins.push("*://scholar.google.no/*");
    //     origins.push("*://scholar.google.pl/*");
    //     origins.push("*://scholar.google.pt/*");
    //     origins.push("*://scholar.google.ro/*");
    //     origins.push("*://scholar.google.ru/*");
    //     origins.push("*://scholar.google.se/*");
    //     origins.push("*://scholar.google.si/*");
    //     origins.push("*://scholar.google.sk/*");
    // }
  // 2) Show them in the UI
  origins.forEach(o => {
    const div = document.createElement('div');
    div.className = 'perm';
    div.textContent = `Site access: ${o}`;
    permListEl.appendChild(div);
  });
  perms.forEach(p => {
    const div = document.createElement('div');
    div.className = 'perm';
    div.textContent = `API permission: ${p}`;
    permListEl.appendChild(div);
  });

  // 3) On click, request them all at once
  btn.addEventListener('click', async () => {
    try {
      const granted = await permissions.request({
        origins: origins,
        permissions: perms
      });
      if (granted) {
        chrome.runtime.sendMessage({ type: 'permissions_granted' });
        await new Promise(resolve => {
          setTimeout(() => {
            resolve();
          }, 500); //Wait for 500ms so that the message is sent to the parent background.js
        });
        alert('Permissions granted! Thank you.');
      } else {
        alert('Permissions denied. Some features may not work.');
      }
      window.close();
    } catch (err) {
      console.error('Permission request failed', err);
      alert('An error occurred. See console for details.');
      // window.close();
    }
  });
})();
